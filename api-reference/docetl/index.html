
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://docetl.com/api-reference/docetl/">
      
      
        <link rel="prev" href="../../examples/rate-limiting/">
      
      
        <link rel="next" href="../cli/">
      
      
      <link rel="icon" href="../../assets/docetl-favicon-color.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.39">
    
    
      
        <title>docetl - docetl docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.8c3ca2c6.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CSource+Code+Pro:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"Source Code Pro"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="#FDB515">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#docetl.DSLRunner" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="docetl docs" class="md-header__button md-logo" aria-label="docetl docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M0 80v48c0 17.7 14.3 32 32 32h64V80c0-26.5-21.5-48-48-48S0 53.5 0 80m112-48c10 13.4 16 30 16 48v304c0 35.3 28.7 64 64 64s64-28.7 64-64v-5.3c0-32.4 26.3-58.7 58.7-58.7H480V128c0-53-43-96-96-96zm352 448c61.9 0 112-50.1 112-112 0-8.8-7.2-16-16-16H314.7c-14.7 0-26.7 11.9-26.7 26.7v5.3c0 53-43 96-96 96h272"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            docetl docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              docetl
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="#FDB515"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="#FDB515"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent="#FDB515"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/ucbepic/docetl" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    ucbepic/docetl
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
    
  
  Home

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../examples/presidential-debate-themes/" class="md-tabs__link">
          
  
    
  
  Examples

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="./" class="md-tabs__link">
          
  
    
  
  API Reference

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../community/" class="md-tabs__link">
          
  
    
  
  Community

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="docetl docs" class="md-nav__button md-logo" aria-label="docetl docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M0 80v48c0 17.7 14.3 32 32 32h64V80c0-26.5-21.5-48-48-48S0 53.5 0 80m112-48c10 13.4 16 30 16 48v304c0 35.3 28.7 64 64 64s64-28.7 64-64v-5.3c0-32.4 26.3-58.7 58.7-58.7H480V128c0-53-43-96-96-96zm352 448c61.9 0 112-50.1 112-112 0-8.8-7.2-16-16-16H314.7c-14.7 0-26.7 11.9-26.7 26.7v5.3c0 53-43 96-96 96h272"/></svg>

    </a>
    docetl docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/ucbepic/docetl" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    ucbepic/docetl
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../.." class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Home
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../examples/presidential-debate-themes/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Examples
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    docetl
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    docetl
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#docetl.DSLRunner" class="md-nav__link">
    <span class="md-ellipsis">
      DSLRunner
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DSLRunner">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.execute_step" class="md-nav__link">
    <span class="md-ellipsis">
      execute_step
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.load_datasets" class="md-nav__link">
    <span class="md-ellipsis">
      load_datasets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.save_output" class="md-nav__link">
    <span class="md-ellipsis">
      save_output
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.syntax_check" class="md-nav__link">
    <span class="md-ellipsis">
      syntax_check
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docetl.Optimizer" class="md-nav__link">
    <span class="md-ellipsis">
      Optimizer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Optimizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.clean_optimized_config" class="md-nav__link">
    <span class="md-ellipsis">
      clean_optimized_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.compute_sample_size" class="md-nav__link">
    <span class="md-ellipsis">
      compute_sample_size
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.optimize" class="md-nav__link">
    <span class="md-ellipsis">
      optimize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.print_optimizer_config" class="md-nav__link">
    <span class="md-ellipsis">
      print_optimizer_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.resolve_anchors" class="md-nav__link">
    <span class="md-ellipsis">
      resolve_anchors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.save_optimized_config" class="md-nav__link">
    <span class="md-ellipsis">
      save_optimized_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.syntax_check" class="md-nav__link">
    <span class="md-ellipsis">
      syntax_check
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    docetl.cli
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../operations/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    docetl.operations
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../optimizers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    docetl.optimizers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../python/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python API
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../community/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Community
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#docetl.DSLRunner" class="md-nav__link">
    <span class="md-ellipsis">
      DSLRunner
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DSLRunner">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.execute_step" class="md-nav__link">
    <span class="md-ellipsis">
      execute_step
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.load_datasets" class="md-nav__link">
    <span class="md-ellipsis">
      load_datasets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.save_output" class="md-nav__link">
    <span class="md-ellipsis">
      save_output
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.DSLRunner.syntax_check" class="md-nav__link">
    <span class="md-ellipsis">
      syntax_check
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docetl.Optimizer" class="md-nav__link">
    <span class="md-ellipsis">
      Optimizer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Optimizer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.clean_optimized_config" class="md-nav__link">
    <span class="md-ellipsis">
      clean_optimized_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.compute_sample_size" class="md-nav__link">
    <span class="md-ellipsis">
      compute_sample_size
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.optimize" class="md-nav__link">
    <span class="md-ellipsis">
      optimize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.print_optimizer_config" class="md-nav__link">
    <span class="md-ellipsis">
      print_optimizer_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.resolve_anchors" class="md-nav__link">
    <span class="md-ellipsis">
      resolve_anchors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.save_optimized_config" class="md-nav__link">
    <span class="md-ellipsis">
      save_optimized_config
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docetl.Optimizer.syntax_check" class="md-nav__link">
    <span class="md-ellipsis">
      syntax_check
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>docetl</h1>

<div class="doc doc-object doc-class">



<h3 id="docetl.DSLRunner" class="doc doc-heading">
            <code>docetl.DSLRunner</code>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="docetl.config_wrapper.ConfigWrapper">ConfigWrapper</span></code></p>


        <p>A class for executing Domain-Specific Language (DSL) configurations.</p>
<p>This class is responsible for loading, validating, and executing DSL configurations
defined in YAML files. It manages datasets, executes pipeline steps, and tracks
the cost of operations.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="docetl.DSLRunner.config">config</span></code></td>
            <td>
                  <code><span title="typing.Dict">Dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The loaded configuration from the YAML file.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.DSLRunner.default_model">default_model</span></code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The default language model to use for operations.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.DSLRunner.max_threads">max_threads</span></code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of threads for parallel processing.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.DSLRunner.console">console</span></code></td>
            <td>
                  <code><span title="rich.console.Console">Console</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Rich console for output formatting.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.DSLRunner.datasets">datasets</span></code></td>
            <td>
                  <code><span title="typing.Dict">Dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Storage for loaded datasets.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>docetl/runner.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">DSLRunner</span><span class="p">(</span><span class="n">ConfigWrapper</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for executing Domain-Specific Language (DSL) configurations.</span>

<span class="sd">    This class is responsible for loading, validating, and executing DSL configurations</span>
<span class="sd">    defined in YAML files. It manages datasets, executes pipeline steps, and tracks</span>
<span class="sd">    the cost of operations.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        config (Dict): The loaded configuration from the YAML file.</span>
<span class="sd">        default_model (str): The default language model to use for operations.</span>
<span class="sd">        max_threads (int): Maximum number of threads for parallel processing.</span>
<span class="sd">        console (Console): Rich console for output formatting.</span>
<span class="sd">        datasets (Dict): Storage for loaded datasets.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">max_threads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the DSLRunner with a YAML configuration file.</span>

<span class="sd">        Args:</span>
<span class="sd">            max_threads (int, optional): Maximum number of threads to use. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ConfigWrapper</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">max_threads</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pipeline&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;intermediate_dir&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Create parsing tool map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parsing_tool_map</span> <span class="o">=</span> <span class="n">create_parsing_tool_map</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parsing_tools&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Check if output path is correctly formatted as JSON</span>
        <span class="n">output_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pipeline&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="n">output_path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">output_path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Output path &#39;</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&#39; is not a JSON or CSV file. Please provide a path ending with &#39;.json&#39; or &#39;.csv&#39;.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No output path specified in the configuration. Please provide an output path ending with &#39;.json&#39; or &#39;.csv&#39; in the configuration.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">syntax_check</span><span class="p">()</span>

        <span class="n">op_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">op</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">op</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]}</span>

        <span class="c1"># Hash each pipeline step/operation</span>
        <span class="c1"># for each step op, hash the code of each op up until and (including that op)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_op_hashes</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]):</span>
                <span class="n">op_name</span> <span class="o">=</span> <span class="n">op</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">all_ops_until_and_including_current</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">op_map</span><span class="p">[</span><span class="n">prev_op</span><span class="p">]</span> <span class="k">for</span> <span class="n">prev_op</span> <span class="ow">in</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">][:</span><span class="n">idx</span><span class="p">]</span>
                <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">op_map</span><span class="p">[</span><span class="n">op_name</span><span class="p">]]</span>
                <span class="c1"># If there&#39;s no model in the op, add the default model</span>
                <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">all_ops_until_and_including_current</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;model&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">op</span><span class="p">:</span>
                        <span class="n">op</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span>

                <span class="n">all_ops_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">all_ops_until_and_including_current</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">step_op_hashes</span><span class="p">[</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]][</span><span class="n">op_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span>
                    <span class="n">all_ops_str</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
                <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">syntax_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a syntax check on all operations defined in the configuration.</span>

<span class="sd">        This method validates each operation by attempting to instantiate it.</span>
<span class="sd">        If any operation fails to instantiate, a ValueError is raised.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If any operation fails the syntax check.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;[yellow]Syntax Check[/yellow]&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
            <span class="s2">&quot;[yellow]Performing syntax check on all operations...[/yellow]&quot;</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">operation_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]:</span>
            <span class="n">operation</span> <span class="o">=</span> <span class="n">operation_config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">operation_type</span> <span class="o">=</span> <span class="n">operation_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">operation_class</span> <span class="o">=</span> <span class="n">get_operation</span><span class="p">(</span><span class="n">operation_type</span><span class="p">)</span>
                <span class="n">operation_class</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">operation_config</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Syntax check failed for operation &#39;</span><span class="si">{</span><span class="n">operation</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[green]Syntax check passed for all operations.[/green]&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">find_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">operation_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">operation_config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">op_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">operation_config</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Operation &#39;</span><span class="si">{</span><span class="n">op_name</span><span class="si">}</span><span class="s2">&#39; not found in configuration.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the entire pipeline defined in the configuration.</span>

<span class="sd">        This method loads datasets, executes each step in the pipeline, saves the output,</span>
<span class="sd">        and returns the total cost of execution.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float: The total cost of executing the pipeline.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;[bold blue]Pipeline Execution[/bold blue]&quot;</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">()</span>
        <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]:</span>
            <span class="n">step_name</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">input_data</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">load</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;input&quot;</span> <span class="ow">in</span> <span class="n">step</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">)</span>
            <span class="n">output_data</span><span class="p">,</span> <span class="n">step_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_step</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">step_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;memory&quot;</span><span class="p">,</span> <span class="n">output_data</span><span class="p">)</span>
            <span class="n">flush_cache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">)</span>
            <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">step_cost</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Step [cyan]</span><span class="si">{</span><span class="n">step_name</span><span class="si">}</span><span class="s2">[/cyan] completed. Cost: [green]$</span><span class="si">{</span><span class="n">step_cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">[/green]&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_output</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># Save the self.step_op_hashes to a file if self.intermediate_dir exists</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span><span class="p">,</span> <span class="s2">&quot;.docetl_intermediate_config.json&quot;</span><span class="p">),</span>
                <span class="s2">&quot;w&quot;</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_op_hashes</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;[bold green]Execution Summary[/bold green]&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold green]Total cost: [green]$</span><span class="si">{</span><span class="n">total_cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">[/green]&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[bold green]Total time: [green]</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds[/green]&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">total_cost</span>

    <span class="k">def</span> <span class="nf">load_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load all datasets defined in the configuration.</span>

<span class="sd">        This method creates Dataset objects for each dataset in the configuration.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If an unsupported dataset type is encountered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;[cyan]Loading Datasets[/cyan]&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dataset_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;datasets&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">dataset_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="s2">&quot;file&quot;</span><span class="p">,</span>
                    <span class="n">dataset_config</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span>
                    <span class="n">source</span><span class="o">=</span><span class="s2">&quot;local&quot;</span><span class="p">,</span>
                    <span class="n">parsing</span><span class="o">=</span><span class="n">dataset_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parsing&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                    <span class="n">user_defined_parsing_tool_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parsing_tool_map</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded dataset: [bold]</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[/bold]&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported dataset type: </span><span class="si">{</span><span class="n">dataset_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the final output of the pipeline.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (List[Dict]): The data to be saved.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If an unsupported output type is specified in the configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;[cyan]Saving Output[/cyan]&quot;</span><span class="p">)</span>
        <span class="n">output_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">output_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">output_config</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_config</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># CSV</span>
                <span class="kn">import</span> <span class="nn">csv</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_config</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                    <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[green italic]💾 Output saved to </span><span class="si">{</span><span class="n">output_config</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">[/green italic]&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported output type: </span><span class="si">{</span><span class="n">output_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute_step</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute a single step in the pipeline.</span>

<span class="sd">        This method runs all operations defined for a step, updating the progress</span>
<span class="sd">        and calculating the cost.</span>

<span class="sd">        Args:</span>
<span class="sd">            step (Dict): The step configuration.</span>
<span class="sd">            input_data (Optional[List[Dict]]): Input data for the step.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[List[Dict], float]: A tuple containing the output data and the total cost of the step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold blue]Executing Step: </span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">[/bold blue]&quot;</span><span class="p">)</span>
        <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">operation</span> <span class="ow">in</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">operation_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">operation_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_operation</span><span class="p">(</span><span class="n">operation_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">operation_name</span> <span class="o">=</span> <span class="n">operation</span>
                <span class="n">operation_config</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># Load from checkpoint if it exists</span>
            <span class="n">attempted_input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_from_checkpoint_if_exists</span><span class="p">(</span>
                <span class="n">step</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">operation_name</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">attempted_input_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">input_data</span> <span class="o">=</span> <span class="n">attempted_input_data</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[green]✓ [italic]Loaded saved data for operation &#39;</span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2">&#39; in step &#39;</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;[/italic][/green]&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">op_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_operation</span><span class="p">(</span><span class="n">operation_name</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">op_object</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">operation_config</span><span class="p">)</span>

            <span class="c1"># If sample is set, sample the input data</span>
            <span class="k">if</span> <span class="n">op_object</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sample&quot;</span><span class="p">):</span>
                <span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">op_object</span><span class="p">[</span><span class="s2">&quot;sample&quot;</span><span class="p">])</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s2">&quot;[bold]Running Operation:[/bold]&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">status</span><span class="p">:</span>
                <span class="n">status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Type: [cyan]</span><span class="si">{</span><span class="n">op_object</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">[/cyan]&quot;</span><span class="p">)</span>
                <span class="n">status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Name: [cyan]</span><span class="si">{</span><span class="n">op_object</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unnamed&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">[/cyan]&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>

                <span class="n">operation_class</span> <span class="o">=</span> <span class="n">get_operation</span><span class="p">(</span><span class="n">op_object</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">])</span>
                <span class="n">operation_instance</span> <span class="o">=</span> <span class="n">operation_class</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">op_object</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">op_object</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;equijoin&quot;</span><span class="p">:</span>
                    <span class="n">left_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">op_object</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
                    <span class="n">right_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">op_object</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
                    <span class="n">input_data</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">operation_instance</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">left_data</span><span class="p">,</span> <span class="n">right_data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">input_data</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">operation_instance</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
                <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">cost</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Operation [cyan]</span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2">[/cyan] completed. Cost: [green]$</span><span class="si">{</span><span class="n">cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">[/green]&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Checkpoint after each operation</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_save_checkpoint</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">operation_name</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">total_cost</span>

    <span class="k">def</span> <span class="nf">_load_from_checkpoint_if_exists</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">step_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">operation_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">intermediate_config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span><span class="p">,</span> <span class="s2">&quot;.docetl_intermediate_config.json&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">intermediate_config_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># See if the checkpoint config is the same as the current step op hash</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">intermediate_config_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">intermediate_config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">intermediate_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">step_name</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">operation_name</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_op_hashes</span><span class="p">[</span><span class="n">step_name</span><span class="p">][</span><span class="n">operation_name</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">checkpoint_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span><span class="p">,</span> <span class="n">step_name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2">.json&quot;</span>
        <span class="p">)</span>
        <span class="c1"># check if checkpoint exists</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">):</span>
            <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="n">checkpoint_path</span><span class="p">,</span> <span class="s2">&quot;local&quot;</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_save_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">operation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save a checkpoint of the current data after an operation.</span>

<span class="sd">        This method creates a JSON file containing the current state of the data</span>
<span class="sd">        after an operation has been executed. The checkpoint is saved in a directory</span>
<span class="sd">        structure that reflects the step and operation names.</span>

<span class="sd">        Args:</span>
<span class="sd">            step_name (str): The name of the current step in the pipeline.</span>
<span class="sd">            operation_name (str): The name of the operation that was just executed.</span>
<span class="sd">            data (List[Dict]): The current state of the data to be checkpointed.</span>

<span class="sd">        Note:</span>
<span class="sd">            The checkpoint is saved only if a checkpoint directory has been specified</span>
<span class="sd">            when initializing the DSLRunner.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">checkpoint_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span><span class="p">,</span> <span class="n">step_name</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2">.json&quot;</span>
        <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[green]✓ [italic]Intermediate saved for operation &#39;</span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2">&#39; in step &#39;</span><span class="si">{</span><span class="n">step_name</span><span class="si">}</span><span class="s2">&#39; at </span><span class="si">{</span><span class="n">checkpoint_path</span><span class="si">}</span><span class="s2">[/italic][/green]&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="docetl.DSLRunner.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">max_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the DSLRunner with a YAML configuration file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>max_threads</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of threads to use. Defaults to None.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>docetl/runner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">max_threads</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the DSLRunner with a YAML configuration file.</span>

<span class="sd">    Args:</span>
<span class="sd">        max_threads (int, optional): Maximum number of threads to use. Defaults to None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ConfigWrapper</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">max_threads</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pipeline&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;intermediate_dir&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Create parsing tool map</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">parsing_tool_map</span> <span class="o">=</span> <span class="n">create_parsing_tool_map</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parsing_tools&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Check if output path is correctly formatted as JSON</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pipeline&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">output_path</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">output_path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="n">output_path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Output path &#39;</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">&#39; is not a JSON or CSV file. Please provide a path ending with &#39;.json&#39; or &#39;.csv&#39;.&quot;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;No output path specified in the configuration. Please provide an output path ending with &#39;.json&#39; or &#39;.csv&#39; in the configuration.&quot;</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">syntax_check</span><span class="p">()</span>

    <span class="n">op_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">op</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">op</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]}</span>

    <span class="c1"># Hash each pipeline step/operation</span>
    <span class="c1"># for each step op, hash the code of each op up until and (including that op)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">step_op_hashes</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]):</span>
            <span class="n">op_name</span> <span class="o">=</span> <span class="n">op</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">all_ops_until_and_including_current</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">op_map</span><span class="p">[</span><span class="n">prev_op</span><span class="p">]</span> <span class="k">for</span> <span class="n">prev_op</span> <span class="ow">in</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">][:</span><span class="n">idx</span><span class="p">]</span>
            <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">op_map</span><span class="p">[</span><span class="n">op_name</span><span class="p">]]</span>
            <span class="c1"># If there&#39;s no model in the op, add the default model</span>
            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">all_ops_until_and_including_current</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;model&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">op</span><span class="p">:</span>
                    <span class="n">op</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span>

            <span class="n">all_ops_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">all_ops_until_and_including_current</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_op_hashes</span><span class="p">[</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]][</span><span class="n">op_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span>
                <span class="n">all_ops_str</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.DSLRunner.execute_step" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute_step</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Execute a single step in the pipeline.</p>
<p>This method runs all operations defined for a step, updating the progress
and calculating the cost.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>step</code></td>
            <td>
                  <code><span title="typing.Dict">Dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The step configuration.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>input_data</code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="typing.Dict">Dict</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input data for the step.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="typing.List">List</span>[<span title="typing.Dict">Dict</span>], float]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tuple[List[Dict], float]: A tuple containing the output data and the total cost of the step.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>docetl/runner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">execute_step</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">input_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute a single step in the pipeline.</span>

<span class="sd">    This method runs all operations defined for a step, updating the progress</span>
<span class="sd">    and calculating the cost.</span>

<span class="sd">    Args:</span>
<span class="sd">        step (Dict): The step configuration.</span>
<span class="sd">        input_data (Optional[List[Dict]]): Input data for the step.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[List[Dict], float]: A tuple containing the output data and the total cost of the step.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold blue]Executing Step: </span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">[/bold blue]&quot;</span><span class="p">)</span>
    <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">operation</span> <span class="ow">in</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">operation_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">operation_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_operation</span><span class="p">(</span><span class="n">operation_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">operation_name</span> <span class="o">=</span> <span class="n">operation</span>
            <span class="n">operation_config</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Load from checkpoint if it exists</span>
        <span class="n">attempted_input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_from_checkpoint_if_exists</span><span class="p">(</span>
            <span class="n">step</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">operation_name</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">attempted_input_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">input_data</span> <span class="o">=</span> <span class="n">attempted_input_data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[green]✓ [italic]Loaded saved data for operation &#39;</span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2">&#39; in step &#39;</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;[/italic][/green]&quot;</span>
            <span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">op_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_operation</span><span class="p">(</span><span class="n">operation_name</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">op_object</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">operation_config</span><span class="p">)</span>

        <span class="c1"># If sample is set, sample the input data</span>
        <span class="k">if</span> <span class="n">op_object</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sample&quot;</span><span class="p">):</span>
            <span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">op_object</span><span class="p">[</span><span class="s2">&quot;sample&quot;</span><span class="p">])</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s2">&quot;[bold]Running Operation:[/bold]&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">status</span><span class="p">:</span>
            <span class="n">status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Type: [cyan]</span><span class="si">{</span><span class="n">op_object</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">[/cyan]&quot;</span><span class="p">)</span>
            <span class="n">status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Name: [cyan]</span><span class="si">{</span><span class="n">op_object</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unnamed&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">[/cyan]&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>

            <span class="n">operation_class</span> <span class="o">=</span> <span class="n">get_operation</span><span class="p">(</span><span class="n">op_object</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">])</span>
            <span class="n">operation_instance</span> <span class="o">=</span> <span class="n">operation_class</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">op_object</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">op_object</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;equijoin&quot;</span><span class="p">:</span>
                <span class="n">left_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">op_object</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
                <span class="n">right_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">op_object</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
                <span class="n">input_data</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">operation_instance</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">left_data</span><span class="p">,</span> <span class="n">right_data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">input_data</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">operation_instance</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
            <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">cost</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Operation [cyan]</span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2">[/cyan] completed. Cost: [green]$</span><span class="si">{</span><span class="n">cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">[/green]&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Checkpoint after each operation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_checkpoint</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">operation_name</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">total_cost</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.DSLRunner.load_datasets" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_datasets</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Load all datasets defined in the configuration.</p>
<p>This method creates Dataset objects for each dataset in the configuration.</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>ValueError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If an unsupported dataset type is encountered.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>docetl/runner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">load_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load all datasets defined in the configuration.</span>

<span class="sd">    This method creates Dataset objects for each dataset in the configuration.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If an unsupported dataset type is encountered.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;[cyan]Loading Datasets[/cyan]&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dataset_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;datasets&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">dataset_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="s2">&quot;file&quot;</span><span class="p">,</span>
                <span class="n">dataset_config</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span>
                <span class="n">source</span><span class="o">=</span><span class="s2">&quot;local&quot;</span><span class="p">,</span>
                <span class="n">parsing</span><span class="o">=</span><span class="n">dataset_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parsing&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="n">user_defined_parsing_tool_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parsing_tool_map</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded dataset: [bold]</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">[/bold]&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported dataset type: </span><span class="si">{</span><span class="n">dataset_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.DSLRunner.run" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Execute the entire pipeline defined in the configuration.</p>
<p>This method loads datasets, executes each step in the pipeline, saves the output,
and returns the total cost of execution.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>float</code></td>            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The total cost of executing the pipeline.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>docetl/runner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute the entire pipeline defined in the configuration.</span>

<span class="sd">    This method loads datasets, executes each step in the pipeline, saves the output,</span>
<span class="sd">    and returns the total cost of execution.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: The total cost of executing the pipeline.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;[bold blue]Pipeline Execution[/bold blue]&quot;</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">()</span>
    <span class="n">total_cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]:</span>
        <span class="n">step_name</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;input&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">load</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;input&quot;</span> <span class="ow">in</span> <span class="n">step</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">output_data</span><span class="p">,</span> <span class="n">step_cost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_step</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">step_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;memory&quot;</span><span class="p">,</span> <span class="n">output_data</span><span class="p">)</span>
        <span class="n">flush_cache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">)</span>
        <span class="n">total_cost</span> <span class="o">+=</span> <span class="n">step_cost</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Step [cyan]</span><span class="si">{</span><span class="n">step_name</span><span class="si">}</span><span class="s2">[/cyan] completed. Cost: [green]$</span><span class="si">{</span><span class="n">step_cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">[/green]&quot;</span>
        <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">save_output</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c1"># Save the self.step_op_hashes to a file if self.intermediate_dir exists</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intermediate_dir</span><span class="p">,</span> <span class="s2">&quot;.docetl_intermediate_config.json&quot;</span><span class="p">),</span>
            <span class="s2">&quot;w&quot;</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_op_hashes</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;[bold green]Execution Summary[/bold green]&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[bold green]Total cost: [green]$</span><span class="si">{</span><span class="n">total_cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">[/green]&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[bold green]Total time: [green]</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds[/green]&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">total_cost</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.DSLRunner.save_output" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_output</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Save the final output of the pipeline.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>data</code></td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.Dict">Dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The data to be saved.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>ValueError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If an unsupported output type is specified in the configuration.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>docetl/runner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">save_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the final output of the pipeline.</span>

<span class="sd">    Args:</span>
<span class="sd">        data (List[Dict]): The data to be saved.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If an unsupported output type is specified in the configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;[cyan]Saving Output[/cyan]&quot;</span><span class="p">)</span>
    <span class="n">output_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;output&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">output_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;file&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">output_config</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_config</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># CSV</span>
            <span class="kn">import</span> <span class="nn">csv</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_config</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[green italic]💾 Output saved to </span><span class="si">{</span><span class="n">output_config</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">[/green italic]&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported output type: </span><span class="si">{</span><span class="n">output_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.DSLRunner.syntax_check" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">syntax_check</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Perform a syntax check on all operations defined in the configuration.</p>
<p>This method validates each operation by attempting to instantiate it.
If any operation fails to instantiate, a ValueError is raised.</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>ValueError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If any operation fails the syntax check.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>docetl/runner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">syntax_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform a syntax check on all operations defined in the configuration.</span>

<span class="sd">    This method validates each operation by attempting to instantiate it.</span>
<span class="sd">    If any operation fails to instantiate, a ValueError is raised.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If any operation fails the syntax check.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;[yellow]Syntax Check[/yellow]&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span>
        <span class="s2">&quot;[yellow]Performing syntax check on all operations...[/yellow]&quot;</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">operation_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]:</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">operation_config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">operation_type</span> <span class="o">=</span> <span class="n">operation_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">operation_class</span> <span class="o">=</span> <span class="n">get_operation</span><span class="p">(</span><span class="n">operation_type</span><span class="p">)</span>
            <span class="n">operation_class</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">operation_config</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">default_model</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Syntax check failed for operation &#39;</span><span class="si">{</span><span class="n">operation</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s2">&quot;[green]Syntax check passed for all operations.[/green]&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="docetl.Optimizer" class="doc doc-heading">
            <code>docetl.Optimizer</code>


</h3>


    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="docetl.config_wrapper.ConfigWrapper">ConfigWrapper</span></code></p>


              <details class="quote">
                <summary>Source code in <code>docetl/builder.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Optimizer</span><span class="p">(</span><span class="n">ConfigWrapper</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_yaml</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">yaml_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># check that file ends with .yaml or .yml</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">yaml_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.yaml&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">yaml_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.yml&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid file type. Please provide a YAML file ending with &#39;.yaml&#39; or &#39;.yml&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="n">base_name</span> <span class="o">=</span> <span class="n">yaml_file</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">yaml_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Optimizer</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">from_yaml</span><span class="p">(</span>
            <span class="n">yaml_file</span><span class="p">,</span> <span class="n">base_name</span><span class="o">=</span><span class="n">base_name</span><span class="p">,</span> <span class="n">yaml_file_suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
        <span class="n">base_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">yaml_file_suffix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">max_threads</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span>
        <span class="n">resume</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the Optimizer class.</span>

<span class="sd">        This method sets up the optimizer with the given configuration file and parameters.</span>
<span class="sd">        It loads the configuration, initializes the console for output, sets up the LLM client,</span>
<span class="sd">        and prepares various attributes for optimization.</span>

<span class="sd">        Args:</span>
<span class="sd">            yaml_file (str): Path to the YAML configuration file.</span>
<span class="sd">            max_threads (Optional[int]): Maximum number of threads to use for parallel processing.</span>
<span class="sd">                If None, it will be set to (number of CPUs * 4).</span>
<span class="sd">            model (str): The name of the language model to use. Defaults to &quot;gpt-4o&quot;.</span>
<span class="sd">            resume (bool): Whether to resume optimization from a previous run. Defaults to False.</span>
<span class="sd">            timeout (int): Timeout in seconds for operations. Defaults to 60.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            yaml_file_path (str): Stores the path to the YAML file.</span>
<span class="sd">            config (Dict): Stores the loaded configuration from the YAML file.</span>
<span class="sd">            console (Console): Rich console for formatted output.</span>
<span class="sd">            optimized_config (Dict): A copy of the original config to be optimized.</span>
<span class="sd">            llm_client (LLMClient): Client for interacting with the language model.</span>
<span class="sd">            max_threads (int): Maximum number of threads for parallel processing.</span>
<span class="sd">            operations_cost (float): Tracks the total cost of operations.</span>
<span class="sd">            timeout (int): Timeout for operations in seconds.</span>
<span class="sd">            selectivities (defaultdict): Stores selectivity information for operations.</span>
<span class="sd">                Selectivity is the ratio of output size to input size for an operation.</span>
<span class="sd">                It&#39;s used to estimate how much data will flow through the pipeline after</span>
<span class="sd">                each operation, which helps in optimizing subsequent operations and</span>
<span class="sd">                determining appropriate sample sizes. For example, a selectivity of 0.5</span>
<span class="sd">                means an operation halves the size of its input data.</span>
<span class="sd">            datasets (Dict): Stores loaded datasets.</span>

<span class="sd">        The method also calls print_optimizer_config() to display the initial configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ConfigWrapper</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">max_threads</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span> <span class="o">=</span> <span class="n">LLMClient</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operations_cost</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selectivities</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samples_taken</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">resume</span>

        <span class="c1"># create parsing tool map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parsing_tool_map</span> <span class="o">=</span> <span class="n">create_parsing_tool_map</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parsing_tools&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">home_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;.docetl/cache/</span><span class="si">{</span><span class="n">yaml_file_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="n">DatasetOnDisk</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimized_ops_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cache_dir</span><span class="si">}</span><span class="s2">/optimized_ops&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_opt.yaml&quot;</span>

        <span class="c1"># Update sample size map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_size_map</span> <span class="o">=</span> <span class="n">SAMPLE_SIZE_MAP</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sample_sizes&quot;</span><span class="p">,</span> <span class="p">{}):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_size_map</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">][</span><span class="s2">&quot;sample_sizes&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">step_op_to_optimized_ops</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">print_optimizer_config</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">find_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">op_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="k">for</span> <span class="n">operation_config</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">operation_config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">op_name</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">operation_config</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Operation &#39;</span><span class="si">{</span><span class="n">op_name</span><span class="si">}</span><span class="s2">&#39; not found in configuration.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">syntax_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a syntax check on all operations defined in the configuration.</span>

<span class="sd">        This method validates each operation by attempting to instantiate it.</span>
<span class="sd">        If any operation fails to instantiate, a ValueError is raised.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If any operation fails the syntax check.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">operation_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]:</span>
            <span class="n">operation</span> <span class="o">=</span> <span class="n">operation_config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="n">operation_type</span> <span class="o">=</span> <span class="n">operation_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">operation_class</span> <span class="o">=</span> <span class="n">get_operation</span><span class="p">(</span><span class="n">operation_type</span><span class="p">)</span>
                <span class="n">operation_class</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="n">operation_config</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_model&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
                    <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Syntax check failed for operation &#39;</span><span class="si">{</span><span class="n">operation</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[green]Syntax check passed for all operations.[/green]&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">print_optimizer_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print the current configuration of the optimizer.</span>

<span class="sd">        This method uses the Rich console to display a formatted output of the optimizer&#39;s</span>
<span class="sd">        configuration. It includes details such as the YAML file path, sample sizes for</span>
<span class="sd">        different operation types, maximum number of threads, the language model being used,</span>
<span class="sd">        and the timeout setting.</span>

<span class="sd">        The output is color-coded and formatted for easy readability, with a header and</span>
<span class="sd">        separator lines to clearly delineate the configuration information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;[bold cyan]Optimizer Configuration[/bold cyan]&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow]Sample Size:[/yellow] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_size_map</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow]Max Threads:[/yellow] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow]Model:[/yellow] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow]Timeout:[/yellow] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_sample_size</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">step_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">step_ops</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">op_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the sample size necessary for optimizing given operation based on upstream operations.</span>

<span class="sd">        This method calculates an appropriate sample size for an operation, taking into</span>
<span class="sd">        account the selectivities of upstream operations in the same step. It uses a</span>
<span class="sd">        predefined sample size map (SAMPLE_SIZE_MAP) as a starting point.</span>

<span class="sd">        For example, if we have a &#39;map&#39; operation with a default sample size of 10,</span>
<span class="sd">        and one upstream operation with a selectivity of 0.5, the computed sample size for the upstream operation would be:</span>
<span class="sd">        10 / 0.5 = 20</span>

<span class="sd">        This ensures that after applying the selectivity of the upstream operation,</span>
<span class="sd">        we still have a representative sample size for the current operation.</span>

<span class="sd">        Args:</span>
<span class="sd">            step_name (str): The name of the current step in the pipeline.</span>
<span class="sd">            step_ops (List[str]): A list of all operations in the current step.</span>
<span class="sd">            op_config (Dict[str, Any]): The configuration dictionary for the current operation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The computed sample size for the operation.</span>

<span class="sd">        The method works as follows:</span>
<span class="sd">        1. If there are no upstream operations, it returns the default sample size for the operation type.</span>
<span class="sd">        2. Otherwise, it starts with the default sample size and adjusts it based on the selectivities</span>
<span class="sd">           of upstream operations.</span>
<span class="sd">        3. It iterates through upstream operations in reverse order, dividing the sample size by</span>
<span class="sd">           each operation&#39;s selectivity.</span>
<span class="sd">        4. The final result is rounded to the nearest integer.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the selectivity for any upstream operation is not found.</span>

<span class="sd">        Note:</span>
<span class="sd">            - The method assumes that selectivities for all upstream operations have been</span>
<span class="sd">              previously computed and stored in self.selectivities.</span>
<span class="sd">            - The sample size is always at least 1, even after all adjustments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If an equijoin, load the default. Equijoins are always first</span>
        <span class="k">if</span> <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;equijoin&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SAMPLE_SIZE_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">))</span>

        <span class="c1"># If there are no upstream operations, use the default sample_size</span>
        <span class="n">upstream_ops</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">step_op</span> <span class="ow">in</span> <span class="n">step_ops</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">step_op</span> <span class="o">!=</span> <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">step_op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_op_to_optimized_ops</span><span class="p">:</span>
                    <span class="n">upstream_ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_op_to_optimized_ops</span><span class="p">[</span><span class="n">step_op</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">upstream_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_op</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">upstream_ops</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">))</span>

        <span class="c1"># Otherwise, compute the sample size based on the upstream operations</span>
        <span class="n">sample_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">upstream_ops</span><span class="p">):</span>
            <span class="c1"># Use the selectivity of the upstream operation to compute the sample size</span>
            <span class="k">if</span> <span class="n">op</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectivities</span><span class="p">[</span><span class="n">step_name</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Selectivity for operation </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="s2"> not found in selectivities. Other ops are </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">selectivities</span><span class="p">[</span><span class="n">step_name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="n">sample_size</span> <span class="o">=</span> <span class="n">sample_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectivities</span><span class="p">[</span><span class="n">step_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">sample_size</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_insert_empty_resolve_operations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines whether to insert resolve operations in the pipeline.</span>

<span class="sd">        This method iterates through each step in the pipeline and checks if there&#39;s a reduce</span>
<span class="sd">        operation that follows a map operation with no resolver in between. If such a case is</span>
<span class="sd">        found, it synthesizes an empty resolver operation and inserts it into the pipeline.</span>

<span class="sd">        The method modifies the pipeline configuration in-place.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Side effects:</span>
<span class="sd">        - Modifies self.config[&quot;pipeline&quot;][&quot;steps&quot;] by potentially inserting new resolve operations.</span>
<span class="sd">        - Adds new resolve operations to self.config[&quot;operations&quot;] if necessary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]):</span>
            <span class="n">operations</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operations&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">has_map</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">has_reduce</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">has_resolve</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">map_op</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">reduce_op</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">operations</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">op</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">op_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_operation</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
                <span class="n">op_type</span> <span class="o">=</span> <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">op_type</span> <span class="o">==</span> <span class="s2">&quot;map&quot;</span><span class="p">:</span>
                    <span class="n">has_map</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">map_op</span> <span class="o">=</span> <span class="n">op</span>
                <span class="k">elif</span> <span class="n">op_type</span> <span class="o">==</span> <span class="s2">&quot;reduce&quot;</span> <span class="ow">and</span> <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;synthesize_resolve&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                    <span class="n">has_reduce</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">reduce_op</span> <span class="o">=</span> <span class="n">op</span>
                <span class="k">elif</span> <span class="n">op_type</span> <span class="o">==</span> <span class="s2">&quot;resolve&quot;</span><span class="p">:</span>
                    <span class="n">has_resolve</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">has_map</span> <span class="ow">and</span> <span class="n">has_reduce</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_resolve</span><span class="p">:</span>
                <span class="c1"># Synthesize an empty resolver</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="s2">&quot;[yellow]Synthesizing empty resolver operation:[/yellow]&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;  • [cyan]Reduce operation:[/cyan] [bold]</span><span class="si">{</span><span class="n">reduce_op</span><span class="si">}</span><span class="s2">[/bold]&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  • [cyan]Step:[/cyan] [bold]</span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">[/bold]&quot;</span><span class="p">)</span>

                <span class="n">new_resolve_op</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;synthesized_resolve_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">reduce_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_operation</span><span class="p">(</span><span class="n">reduce_op</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reduce_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">reduce_key</span> <span class="o">=</span> <span class="p">[</span><span class="n">reduce_key</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">new_resolve_op</span><span class="p">,</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;resolve&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;empty&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s2">&quot;optimize&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                        <span class="s2">&quot;embedding_model&quot;</span><span class="p">:</span> <span class="s2">&quot;text-embedding-3-small&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;resolution_model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;default_model&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4o-mini&quot;</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;comparison_model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;default_model&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4o-mini&quot;</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;_intermediates&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;map_prompt&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_operation</span><span class="p">(</span><span class="n">map_op</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prompt&quot;</span><span class="p">),</span>
                            <span class="s2">&quot;reduce_key&quot;</span><span class="p">:</span> <span class="n">reduce_key</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">}</span>
                <span class="p">)</span>

                <span class="c1"># Insert the new resolve operation before the reduce operation</span>
                <span class="n">reduce_index</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
                    <span class="n">i</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">operations</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_operation</span><span class="p">(</span><span class="n">op</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;reduce&quot;</span>
                <span class="p">)</span>
                <span class="n">operations</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">reduce_index</span><span class="p">,</span> <span class="n">new_resolve_op</span><span class="p">)</span>

                <span class="n">has_resolve</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">operations</span>

        <span class="c1"># Update the pipeline configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_add_map_prompts_to_reduce_operations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add relevant map prompts to reduce operations based on their reduce keys.</span>

<span class="sd">        This method iterates through all map operations to create a dictionary mapping</span>
<span class="sd">        output schema keys to map prompts. It then loops through reduce operations,</span>
<span class="sd">        adding the relevant map prompts based on the reduce keys and output schema.</span>

<span class="sd">        Side effects:</span>
<span class="sd">        - Modifies reduce operations in self.config[&quot;operations&quot;] by adding map prompts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create a dictionary mapping output schema keys to map prompts</span>
        <span class="n">output_key_to_prompt</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">op_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;map&quot;</span><span class="p">:</span>
                <span class="n">output_schema</span> <span class="o">=</span> <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;schema&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">prompt</span> <span class="o">=</span> <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prompt&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">output_schema</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">output_key_to_prompt</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">prompt</span>

        <span class="c1"># Add relevant map prompts to reduce operations</span>
        <span class="k">for</span> <span class="n">op_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;reduce&quot;</span><span class="p">:</span>
                <span class="n">reduce_keys</span> <span class="o">=</span> <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reduce_keys</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">reduce_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">reduce_keys</span><span class="p">]</span>

                <span class="n">relevant_prompts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">reduce_keys</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">output_key_to_prompt</span><span class="p">:</span>
                        <span class="n">relevant_prompts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output_key_to_prompt</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">relevant_prompts</span><span class="p">:</span>
                    <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;_intermediates&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_intermediates&quot;</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;_intermediates&quot;</span><span class="p">][</span><span class="s2">&quot;last_map_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relevant_prompts</span><span class="p">[</span>
                        <span class="o">-</span><span class="mi">1</span>
                    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_load_optimized_ops</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the optimized operations from disk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimized_ops_path</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimized_ops_path</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
                    <span class="n">original_op_name</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>  <span class="c1"># Remove &#39;.json&#39; from the filename</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimized_ops_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span>
                    <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">optimized_ops</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

                    <span class="c1"># Update the config with the optimized operations</span>
                    <span class="k">if</span> <span class="n">original_op_name</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="n">op</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span>
                    <span class="p">]:</span>
                        <span class="c1"># Update the config with the optimized operations</span>
                        <span class="c1"># First, remove all operations that are already in the config with the same name</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">op</span>
                            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">op</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">original_op_name</span>
                        <span class="p">]</span>

                        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">optimized_ops</span><span class="p">:</span>
                            <span class="n">op</span><span class="p">[</span><span class="s2">&quot;optimize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>

                        <span class="c1"># Update the step operations</span>
                        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">original_op_name</span> <span class="ow">in</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]:</span>
                                <span class="n">index</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">original_op_name</span><span class="p">)</span>
                                <span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">][:</span><span class="n">index</span><span class="p">]</span>
                                    <span class="o">+</span> <span class="p">[</span><span class="n">op</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">optimized_ops</span><span class="p">]</span>
                                    <span class="o">+</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">][</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
                                <span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Loaded optimized operations for </span><span class="si">{</span><span class="n">original_op_name</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[green]Finished loading optimized operations[/green]&quot;</span><span class="p">)</span>

            <span class="c1"># Print out the operations for each step</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[bold blue]Operations for each step:[/bold blue]&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]:</span>
                <span class="n">step_name</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
                <span class="n">operations</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operations&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[cyan]Step: </span><span class="si">{</span><span class="n">step_name</span><span class="si">}</span><span class="s2">[/cyan]&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">operations</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="c1"># Handle the case where the operation is a dictionary (e.g., for equijoin)</span>
                        <span class="n">op_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">op_details</span> <span class="o">=</span> <span class="n">op</span><span class="p">[</span><span class="n">op_name</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">op_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">op_details</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># Add a blank line between steps</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[yellow]No optimized operations found[/yellow]&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optimize the entire pipeline defined in the configuration.</span>

<span class="sd">        This method is the main entry point for the optimization process. It iterates through</span>
<span class="sd">        each step in the pipeline, optimizing from upstream to downstream, and constructs an</span>
<span class="sd">        optimized version of the configuration.</span>

<span class="sd">        The optimization process includes:</span>
<span class="sd">        1. Iterating through each step in the pipeline, from upstream to downstream.</span>
<span class="sd">        2. Optimizing each step using the _optimize_step method.</span>
<span class="sd">        3. Updating the optimized configuration with the new operations and steps.</span>
<span class="sd">        4. Saving the optimized configuration to a file.</span>
<span class="sd">        5. Logging the total costs (agent cost, operations cost, and total cost).</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>

<span class="sd">        Side effects:</span>
<span class="sd">        - Modifies self.optimized_config with the optimized pipeline and operations.</span>
<span class="sd">        - Updates self.datasets with the results of each step.</span>
<span class="sd">        - Calls _save_optimized_config to save the optimized configuration to a file.</span>
<span class="sd">        - Logs cost information to the console.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If a step in the pipeline does not have a name.</span>

<span class="sd">        Note:</span>
<span class="sd">        - This method assumes that all necessary data and configurations are already</span>
<span class="sd">          loaded and initialized in the Optimizer instance.</span>
<span class="sd">        - The optimization process is performed step by step, from upstream to downstream,</span>
<span class="sd">          with each step potentially depending on the results of previous steps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;[bold cyan]Beginning Pipeline Optimization[/bold cyan]&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">syntax_check</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_insert_empty_resolve_operations</span><span class="p">()</span>

        <span class="c1"># If resume is True, load the optimized operations from disk</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resume</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_optimized_ops</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]:</span>
            <span class="n">step_name</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">step_name</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Step does not have a name. Each step must have a unique name.&quot;</span>
                <span class="p">)</span>

            <span class="n">optimized_step</span><span class="p">,</span> <span class="n">step_operations</span><span class="p">,</span> <span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
            <span class="n">old_op_names</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">op</span>
                <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">op</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">optimized_step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span>
            <span class="p">]</span>

            <span class="c1"># Remove all old_op_names from self.optimized_config[&quot;operations&quot;]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">op</span>
                <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">op</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">old_op_names</span>
            <span class="p">]</span>

            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">optimized_step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]:</span>
                <span class="n">changed_op</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">op_config</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">op</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_operations</span><span class="p">[</span><span class="n">op</span><span class="p">]</span>
                        <span class="n">changed_op</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">changed_op</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_operations</span><span class="p">[</span><span class="n">op</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">step</span>
                <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">step_name</span>
            <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">optimized_step</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">step_op_to_optimized_ops</span><span class="p">[</span><span class="n">step_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimized_step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span>

            <span class="n">step_hash</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="p">[</span>
                                <span class="n">s</span>
                                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">step_name</span>
                            <span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="s2">&quot;operations&quot;</span><span class="p">:</span> <span class="p">[</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">find_operation</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">optimized_step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span>
                            <span class="p">],</span>
                        <span class="p">}</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
                <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
                <span class="o">+</span> <span class="s2">&quot;.json&quot;</span>
            <span class="p">)</span>
            <span class="c1"># If the dataset already exists, skip the step</span>
            <span class="k">if</span> <span class="n">step_hash</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">flush_cache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">step_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;run_full_step&quot;</span><span class="p">,</span> <span class="p">[]</span>
            <span class="p">):</span>
                <span class="c1"># Run the entire step</span>
                <span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_partial_step</span><span class="p">(</span>
                    <span class="n">step</span><span class="p">,</span>
                    <span class="n">step_operations</span><span class="p">,</span>
                    <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">),</span>  <span class="c1"># TODO: FIX THIS</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">step_hash</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">step_hash</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[bold]Total agent cost: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">total_cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">[/bold]&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[bold]Total operations cost: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">operations_cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">[/bold]&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[bold]Total cost: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">total_cost</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">operations_cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">[/bold]&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_run_partial_step</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">step</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">ops_to_run</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">optimized_operations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute a partial step of the pipeline on a sample of the input data.</span>

<span class="sd">        This internal method runs a subset of operations for a given step on a sample</span>
<span class="sd">        of the input data. It&#39;s used as part of the optimization process to evaluate</span>
<span class="sd">        and optimize individual operations within a step.</span>

<span class="sd">        Args:</span>
<span class="sd">            step (Dict[str, Any]): The step configuration dictionary.</span>
<span class="sd">            ops_to_run (List[str]): List of operation names to execute in this partial step.</span>
<span class="sd">            sample_size (int): The number of items to include in the input sample.</span>
<span class="sd">            optimized_operations (Dict[str, Dict[str, Any]]): Dictionary of optimized operations.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Dict[str, Any]]: The output data after running the specified operations.</span>

<span class="sd">        The method performs the following steps:</span>
<span class="sd">        1. Retrieves a sample of the input data using _get_sample_data.</span>
<span class="sd">        2. For equijoin operations, it loads both left and right datasets.</span>
<span class="sd">        3. Iterates through the specified operations, running each on the input sample.</span>
<span class="sd">        4. Returns the final output after all specified operations have been applied.</span>

<span class="sd">        Note:</span>
<span class="sd">        - The method handles both regular steps and equijoin steps differently.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Any exceptions raised by _get_sample_data or _run_operation methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Take the input data and run the operations in ops_to_run</span>
        <span class="c1"># Return the output data</span>
        <span class="n">input_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sample_data</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">join_op_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operations&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># this is an equijoin step, load left and right datasets</span>
            <span class="n">left_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sample_data</span><span class="p">(</span>
                <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operations&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="n">join_op_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sample_size</span>
            <span class="p">)</span>
            <span class="n">right_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_sample_data</span><span class="p">(</span>
                <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operations&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="n">join_op_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sample_size</span>
            <span class="p">)</span>
            <span class="n">input_sample</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="n">left_data</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="n">right_data</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">ops_to_run</span><span class="p">:</span>
            <span class="n">op_object</span> <span class="o">=</span> <span class="n">optimized_operations</span><span class="p">[</span><span class="n">op</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">op_object</span><span class="p">:</span>
                <span class="n">op_object</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span>

            <span class="n">input_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_operation</span><span class="p">(</span><span class="n">op_object</span><span class="p">,</span> <span class="n">input_sample</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">input_sample</span>

    <span class="k">def</span> <span class="nf">_optimize_step</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optimize a single step in the pipeline.</span>

<span class="sd">        This method takes a step configuration and optimizes each operation within it.</span>
<span class="sd">        It handles different types of operations, including those that require optimization</span>
<span class="sd">        and those that don&#39;t.</span>

<span class="sd">        Args:</span>
<span class="sd">            step (Dict[str, Any]): The configuration dictionary for the step to be optimized.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[Dict[str, Any], List[Dict[str, Any]], List[Dict[str, Any]]]:</span>
<span class="sd">                - The optimized step configuration.</span>
<span class="sd">                - A list of optimized operations.</span>
<span class="sd">                - The output data after running all operations in the step.</span>

<span class="sd">        The method performs the following for each operation in the step:</span>
<span class="sd">        1. Extracts the operation configuration.</span>
<span class="sd">        2. Computes the appropriate sample size for the operation.</span>
<span class="sd">        3. Runs the operation on a sample of the input data.</span>
<span class="sd">        4. If the operation is optimizable and of a supported type, it calls the appropriate</span>
<span class="sd">           optimization method (e.g., _optimize_map, _optimize_reduce).</span>
<span class="sd">        5. If not optimizable or not supported, it runs the operation as-is.</span>
<span class="sd">        6. Calculates and stores the selectivity of each operation.</span>
<span class="sd">        7. Updates the list of optimized operations and their configurations.</span>

<span class="sd">        The method uses rich console to provide status updates during the optimization process.</span>

<span class="sd">        Note:</span>
<span class="sd">        - This method is a key part of the overall optimization process, focusing on</span>
<span class="sd">          individual steps in the pipeline.</span>
<span class="sd">        - It relies on several helper methods like _run_partial_step, compute_sample_size,</span>
<span class="sd">          and various _optimize_* methods for specific operation types.</span>
<span class="sd">        - When optimizing an operation in the step, all previous operations are run on the</span>
<span class="sd">          sample size needed for the current operation. This ensures that the input to the</span>
<span class="sd">          operation being optimized is representative of what it would receive in the full pipeline.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If an unsupported operation type is encountered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">optimized_operations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">optimized_operation_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">replacement_operations</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># List from old op name to new ops</span>

        <span class="k">for</span> <span class="n">op_idx</span><span class="p">,</span> <span class="n">operation</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">operation_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">operation_config</span> <span class="o">=</span> <span class="n">operation</span><span class="p">[</span><span class="n">operation_name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">operation_name</span> <span class="o">=</span> <span class="n">operation</span>
                <span class="n">operation_config</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">op_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_operation</span><span class="p">(</span><span class="n">operation_name</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">op_object</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">operation_config</span><span class="p">)</span>
            <span class="n">op_object</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">operation_name</span>

            <span class="c1"># Run the pipeline</span>
            <span class="n">step_ops</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">step_op</span> <span class="ow">in</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;operations&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">step_op</span> <span class="ow">in</span> <span class="n">replacement_operations</span><span class="p">:</span>
                    <span class="n">step_ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">replacement_operations</span><span class="p">[</span><span class="n">step_op</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">step_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_op</span><span class="p">)</span>

            <span class="c1"># TODO: incorporate this into the optimizer to not run the most downstream operations</span>
            <span class="n">downstream_ops_exist</span> <span class="o">=</span> <span class="n">op_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="n">sample_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_sample_size</span><span class="p">(</span>
                <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span> <span class="n">step_ops</span><span class="p">,</span> <span class="n">op_object</span>
            <span class="p">)</span>
            <span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_partial_step</span><span class="p">(</span>
                <span class="n">step</span><span class="p">,</span> <span class="n">optimized_operation_names</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">,</span> <span class="n">optimized_operations</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="n">op_object</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimize&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>  <span class="c1"># Default don&#39;t optimize</span>
                <span class="ow">or</span> <span class="n">op_object</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SUPPORTED_OPS</span>
            <span class="p">):</span>
                <span class="c1"># If optimize is False or operation type is not supported, just use the operation without optimization</span>
                <span class="n">output_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_operation</span><span class="p">(</span><span class="n">op_object</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>
                <span class="n">optimized_operations</span><span class="p">[</span><span class="n">operation_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">op_object</span>
                <span class="n">optimized_operation_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">operation_name</span><span class="p">)</span>

                <span class="n">selectivity</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_data</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">selectivities</span><span class="p">[</span><span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)][</span><span class="n">operation_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">selectivity</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">samples_taken</span><span class="p">[</span><span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)][</span><span class="n">operation_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_size</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Use rich console status to indicate optimization of the operation</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">status</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[bold blue]Optimizing operation: </span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2"> (Type: </span><span class="si">{</span><span class="n">op_object</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)[/bold blue]&quot;</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">status</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>

                    <span class="c1"># Print the number of elements in input_data</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;[yellow]Optimizing operation </span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2"> (Type: </span><span class="si">{</span><span class="n">op_object</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)[/yellow]&quot;</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">op_object</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;equijoin&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;[yellow]  Sample size (left): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">[/yellow]&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;[yellow]  Sample size (right): </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">[/yellow]&quot;</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;[yellow]  Sample size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span><span class="si">}</span><span class="s2">[/yellow]&quot;</span>
                        <span class="p">)</span>

                    <span class="c1"># Run optimization</span>
                    <span class="k">for</span> <span class="n">retry</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s2">&quot;num_retries&quot;</span><span class="p">,</span> <span class="n">NUM_OPTIMIZER_RETRIES</span>
                        <span class="p">)</span>
                    <span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">op_object</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;map&quot;</span><span class="p">:</span>
                                <span class="n">optimized_ops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_map</span><span class="p">(</span>
                                    <span class="n">op_object</span><span class="p">,</span> <span class="n">input_data</span>
                                <span class="p">)</span>
                            <span class="k">elif</span> <span class="n">op_object</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;filter&quot;</span><span class="p">:</span>
                                <span class="n">optimized_ops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_map</span><span class="p">(</span>
                                    <span class="n">op_object</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">is_filter</span><span class="o">=</span><span class="kc">True</span>
                                <span class="p">)</span>
                            <span class="k">elif</span> <span class="n">op_object</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;reduce&quot;</span><span class="p">:</span>
                                <span class="n">optimized_ops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_reduce</span><span class="p">(</span>
                                    <span class="n">op_object</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">status</span>
                                <span class="p">)</span>
                            <span class="k">elif</span> <span class="n">op_object</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;resolve&quot;</span><span class="p">:</span>
                                <span class="n">optimized_ops</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_resolve</span><span class="p">(</span>
                                    <span class="n">op_object</span><span class="p">,</span> <span class="n">input_data</span>
                                <span class="p">)</span>
                            <span class="k">elif</span> <span class="n">op_object</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;equijoin&quot;</span><span class="p">:</span>
                                <span class="p">(</span>
                                    <span class="n">optimized_ops</span><span class="p">,</span>
                                    <span class="n">input_data</span><span class="p">,</span>
                                    <span class="n">new_left_name</span><span class="p">,</span>
                                    <span class="n">new_right_name</span><span class="p">,</span>
                                <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_equijoin</span><span class="p">(</span>
                                    <span class="n">op_object</span><span class="p">,</span>
                                    <span class="n">operation</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">],</span>
                                    <span class="n">operation</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">],</span>
                                    <span class="n">input_data</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">],</span>
                                    <span class="n">input_data</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">],</span>
                                    <span class="n">status</span><span class="p">,</span>
                                <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;Unsupported operation type: </span><span class="si">{</span><span class="n">op_object</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">)</span>
                            <span class="k">break</span>  <span class="c1"># If successful, break out of the retry loop</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span>
                                <span class="n">retry</span>
                                <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                    <span class="s2">&quot;num_retries&quot;</span><span class="p">,</span> <span class="n">NUM_OPTIMIZER_RETRIES</span>
                                <span class="p">)</span>
                                <span class="o">-</span> <span class="mi">1</span>
                            <span class="p">):</span>
                                <span class="k">raise</span>  <span class="c1"># If this was the last retry, re-raise the exception</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Optimization attempt </span><span class="si">{</span><span class="n">retry</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> failed. Retrying...&quot;</span>
                            <span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;[bold blue]Running optimized operation to estimate selectivities: </span><span class="si">{</span><span class="n">operation_name</span><span class="si">}</span><span class="s2">[/bold blue]&quot;</span>
                        <span class="p">)</span>

                    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">optimized_ops</span><span class="p">:</span>
                        <span class="n">op_name</span> <span class="o">=</span> <span class="n">op</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                        <span class="n">optimized_operations</span><span class="p">[</span><span class="n">op_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span>
                        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;equijoin&quot;</span><span class="p">:</span>
                            <span class="n">optimized_operation_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">{</span>
                                    <span class="n">op_name</span><span class="p">:</span> <span class="p">{</span>
                                        <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="n">new_left_name</span><span class="p">,</span>
                                        <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="n">new_right_name</span><span class="p">,</span>
                                    <span class="p">}</span>
                                <span class="p">}</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">optimized_operation_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">op_name</span><span class="p">)</span>

                        <span class="n">old_input_data_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
                        <span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_operation</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>
                        <span class="n">new_input_data_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
                        <span class="n">selectivity</span> <span class="o">=</span> <span class="n">new_input_data_size</span> <span class="o">/</span> <span class="n">old_input_data_size</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">selectivities</span><span class="p">[</span><span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)][</span><span class="n">op_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">selectivity</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">samples_taken</span><span class="p">[</span><span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)][</span><span class="n">op_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sample_size</span>

                    <span class="c1"># Set replacement_operations</span>
                    <span class="n">replacement_operations</span><span class="p">[</span><span class="n">op_object</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">o</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">optimized_ops</span>
                    <span class="p">]</span>

                    <span class="c1"># Print new operator configs</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[bold green]New op configurations:[/bold green]&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">op_name</span><span class="p">,</span> <span class="n">op_config</span> <span class="ow">in</span> <span class="n">optimized_operations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">op_name</span> <span class="ow">in</span> <span class="p">[</span><span class="n">o</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">optimized_ops</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;[cyan]</span><span class="si">{</span><span class="n">op_name</span><span class="si">}</span><span class="s2">:[/cyan] </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">op_config</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>

                    <span class="c1"># Save the optimized operations to disk</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimized_ops_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">original_op</span><span class="p">,</span> <span class="n">replacement_ops</span> <span class="ow">in</span> <span class="n">replacement_operations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">optimized_ops_list</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="p">(</span>
                                <span class="n">optimized_operations</span><span class="p">[</span><span class="n">op_name</span><span class="p">]</span>
                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                                <span class="k">else</span> <span class="p">{</span>
                                    <span class="nb">list</span><span class="p">(</span><span class="n">op_name</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">optimized_operations</span><span class="p">[</span>
                                        <span class="nb">list</span><span class="p">(</span><span class="n">op_name</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="p">]</span>
                                <span class="p">}</span>
                            <span class="p">)</span>
                            <span class="k">for</span> <span class="n">op_name</span> <span class="ow">in</span> <span class="n">replacement_ops</span>
                        <span class="p">]</span>

                        <span class="c1"># Save to disk</span>
                        <span class="n">optimized_op_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">optimized_ops_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">original_op</span><span class="si">}</span><span class="s2">.json&quot;</span>
                        <span class="p">)</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">optimized_op_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">optimized_ops_list</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;[green]Saved optimized operations to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">optimized_ops_path</span><span class="si">}</span><span class="s2">[/green]&quot;</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">output_data</span> <span class="o">=</span> <span class="n">input_data</span>

        <span class="n">optimized_step</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">optimized_step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimized_operation_names</span>
        <span class="k">return</span> <span class="n">optimized_step</span><span class="p">,</span> <span class="n">optimized_operations</span><span class="p">,</span> <span class="n">output_data</span>

    <span class="k">def</span> <span class="nf">_get_sample_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">dataset_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">op_config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve a sample of data from a specified dataset.</span>

<span class="sd">        This method loads data from either a previously processed dataset or from a file,</span>
<span class="sd">        and returns a sample of the data based on the given sample size and operation configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset_name (str): The name of the dataset to sample from.</span>
<span class="sd">            op_config (Optional[Dict[str, Any]]): The configuration of the operation to be performed.</span>
<span class="sd">                                                  This is used to determine if special sampling is needed.</span>
<span class="sd">            sample_size (int): The desired size of the sample. If set to float(&#39;inf&#39;), all data is returned.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Dict[str, Any]]: A list of dictionaries representing the sampled data.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the dataset is not found or if the dataset type is unsupported.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dataset_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">s</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dataset_name</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">step</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">s</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dataset_name</span>
            <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">name_hash</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="n">step</span><span class="p">,</span>
                            <span class="s2">&quot;operations&quot;</span><span class="p">:</span> <span class="p">[</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">find_operation</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span>
                            <span class="p">],</span>
                        <span class="p">}</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
                <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
                <span class="o">+</span> <span class="s2">&quot;.json&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name_hash</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">name_hash</span> <span class="ow">and</span> <span class="n">name_hash</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">name_hash</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dataset_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;datasets&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dataset_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dataset_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Dataset &#39;</span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">&#39; not found in config or previous steps.&quot;</span>
                <span class="p">)</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span>
                <span class="n">runner</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">dataset_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span>
                <span class="n">path_or_data</span><span class="o">=</span><span class="n">dataset_config</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span>
                <span class="n">parsing</span><span class="o">=</span><span class="n">dataset_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parsing&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="n">user_defined_parsing_tool_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parsing_tool_map</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">sample_size</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="k">if</span> <span class="n">op_config</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;reduce&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_reduce_sample</span><span class="p">(</span>
                    <span class="n">data</span><span class="p">,</span> <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reduce_key&quot;</span><span class="p">),</span> <span class="n">sample_size</span>
                <span class="p">)</span>

        <span class="c1"># Take the random 500 examples or all if less than 500</span>
        <span class="n">initial_data</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>

        <span class="c1"># Calculate counts for each example</span>
        <span class="n">char_counts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">))</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">initial_data</span><span class="p">]</span>
        <span class="n">total_counts</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">char_counts</span><span class="p">)</span>

        <span class="c1"># Calculate weights based on word counts</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">count</span> <span class="o">/</span> <span class="n">total_counts</span> <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">char_counts</span><span class="p">]</span>

        <span class="c1"># Perform weighted random sampling</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span>
            <span class="n">initial_data</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">sample_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">initial_data</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_reduce_sample</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">reduce_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a representative sample for a reduce operation.</span>

<span class="sd">        This method creates a sample that preserves the distribution of groups in the data,</span>
<span class="sd">        focusing on the top 5 largest groups. It also generates and prints a histogram of group sizes.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (List[Dict[str, Any]]): The full dataset to sample from.</span>
<span class="sd">            reduce_key (str): The key used for grouping in the reduce operation.</span>
<span class="sd">            sample_size (int): The desired size of the sample.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Dict[str, Any]]: A list of dictionaries representing the sampled data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Group data by reduce key</span>
        <span class="n">grouped_data</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">grouped_data</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="n">reduce_key</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="c1"># Sort groups by size in descending order</span>
        <span class="n">sorted_groups</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">grouped_data</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="n">sample</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Take the top 5 groups</span>
        <span class="n">top_5_groups</span> <span class="o">=</span> <span class="n">sorted_groups</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>

        <span class="c1"># Calculate the total count of items in the top 5 groups</span>
        <span class="n">total_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">top_5_groups</span><span class="p">)</span>

        <span class="n">sample</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">top_5_groups</span><span class="p">:</span>
            <span class="c1"># Calculate the proportion of items to sample from this group</span>
            <span class="n">group_proportion</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_count</span>
            <span class="n">group_sample_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sample_size</span> <span class="o">*</span> <span class="n">group_proportion</span><span class="p">)</span>

            <span class="c1"># Sample from the group</span>
            <span class="n">group_sample</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">group_sample_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)))</span>
            <span class="n">sample</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">group_sample</span><span class="p">)</span>

        <span class="c1"># If we haven&#39;t reached the desired sample size, add more items randomly</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">sample_size</span><span class="p">:</span>
            <span class="n">remaining_items</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">item</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">top_5_groups</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sample</span>
            <span class="p">]</span>
            <span class="n">additional_sample</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                <span class="n">remaining_items</span><span class="p">,</span>
                <span class="nb">min</span><span class="p">(</span><span class="n">sample_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining_items</span><span class="p">)),</span>
            <span class="p">)</span>
            <span class="n">sample</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">additional_sample</span><span class="p">)</span>

        <span class="c1"># Add items randomly from non-top groups to meet the sample size</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">sample_size</span><span class="p">:</span>
            <span class="n">remaining_items</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">item</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">grouped_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sample</span>
            <span class="p">]</span>
            <span class="n">additional_sample</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                <span class="n">remaining_items</span><span class="p">,</span>
                <span class="nb">min</span><span class="p">(</span><span class="n">sample_size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining_items</span><span class="p">)),</span>
            <span class="p">)</span>
            <span class="n">sample</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">additional_sample</span><span class="p">)</span>

        <span class="c1"># Create a histogram of group sizes</span>
        <span class="n">group_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">grouped_data</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">size_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">group_sizes</span><span class="p">)</span>

        <span class="c1"># Sort the sizes for a more readable output</span>
        <span class="n">sorted_sizes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">size_counts</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="c1"># Print the histogram</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[bold]Histogram of Group Sizes:[/bold]&quot;</span><span class="p">)</span>
        <span class="n">max_bar_width</span><span class="p">,</span> <span class="n">max_count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">size_counts</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">size</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">sorted_sizes</span><span class="p">[:</span><span class="mi">5</span><span class="p">]:</span>
            <span class="n">normalized_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">count</span> <span class="o">/</span> <span class="n">max_count</span> <span class="o">*</span> <span class="n">max_bar_width</span><span class="p">)</span>
            <span class="n">bar</span> <span class="o">=</span> <span class="s2">&quot;█&quot;</span> <span class="o">*</span> <span class="n">normalized_count</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">size</span><span class="si">:</span><span class="s2">3d</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">bar</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sample</span>

    <span class="k">def</span> <span class="nf">_optimize_reduce</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">op_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">status</span><span class="p">:</span> <span class="n">Status</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optimize a reduce operation.</span>

<span class="sd">        This method creates a ReduceOptimizer instance and uses it to optimize the reduce operation.</span>

<span class="sd">        Args:</span>
<span class="sd">            op_config (Dict[str, Any]): The configuration of the reduce operation.</span>
<span class="sd">            input_data (List[Dict[str, Any]]): The input data for the reduce operation.</span>
<span class="sd">            status (Status): The status object to update with the progress of the optimization.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Dict[str, Any]]: The optimized operation configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reduce_optimizer</span> <span class="o">=</span> <span class="n">ReduceOptimizer</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_operation</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">optimized_ops</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">reduce_optimizer</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operations_cost</span> <span class="o">+=</span> <span class="n">cost</span>
        <span class="k">return</span> <span class="n">optimized_ops</span>

    <span class="k">def</span> <span class="nf">_optimize_equijoin</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">op_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">left_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">right_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">left_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">right_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">status</span><span class="p">:</span> <span class="n">Status</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optimize an equijoin operation.</span>

<span class="sd">        This method creates a JoinOptimizer instance and uses it to optimize the equijoin operation.</span>
<span class="sd">        It updates the operation cost and runs the optimized operation.</span>
<span class="sd">        If the LLM suggests a map transformation, it will optimize the map operation as its own step, and then go back to optimize the equijoin operation.</span>

<span class="sd">        Args:</span>
<span class="sd">            op_config (Dict[str, Any]): The configuration of the equijoin operation.</span>
<span class="sd">            left_name (str): The name of the left dataset.</span>
<span class="sd">            right_name (str): The name of the right dataset.</span>
<span class="sd">            left_data (List[Dict[str, Any]]): The left dataset for the join.</span>
<span class="sd">            right_data (List[Dict[str, Any]]): The right dataset for the join.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[List[Dict[str, Any]], Dict[str, List[Dict[str, Any]]], str, str]: The optimized operation configuration, the new left and right datasets, and the new left and right names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_iterations</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">new_left_name</span> <span class="o">=</span> <span class="n">left_name</span>
        <span class="n">new_right_name</span> <span class="o">=</span> <span class="n">right_name</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iterations</span><span class="p">):</span>
            <span class="n">join_optimizer</span> <span class="o">=</span> <span class="n">JoinOptimizer</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                <span class="n">op_config</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
                <span class="n">target_recall</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;equijoin&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_recall&quot;</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
                <span class="n">estimated_selectivity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;equijoin&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;estimated_selectivity&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">optimized_config</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">agent_results</span> <span class="o">=</span> <span class="n">join_optimizer</span><span class="o">.</span><span class="n">optimize_equijoin</span><span class="p">(</span>
                <span class="n">left_data</span><span class="p">,</span> <span class="n">right_data</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">operations_cost</span> <span class="o">+=</span> <span class="n">cost</span>
            <span class="c1"># Update the operation config with the optimized values</span>
            <span class="n">op_config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">optimized_config</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">agent_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimize_map&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">break</span>  <span class="c1"># Exit the loop if no more map optimizations are necessary</span>

            <span class="c1"># Update the status to indicate we&#39;re optimizing a map operation</span>
            <span class="n">output_key</span> <span class="o">=</span> <span class="n">agent_results</span><span class="p">[</span><span class="s2">&quot;output_key&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Optimizing map operation for </span><span class="si">{</span><span class="n">output_key</span><span class="si">}</span><span class="s2"> extraction to help with the equijoin&quot;</span>
                <span class="p">)</span>
            <span class="n">map_prompt</span> <span class="o">=</span> <span class="n">agent_results</span><span class="p">[</span><span class="s2">&quot;map_prompt&quot;</span><span class="p">]</span>
            <span class="n">dataset_to_transform</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">left_data</span>
                <span class="k">if</span> <span class="n">agent_results</span><span class="p">[</span><span class="s2">&quot;dataset_to_transform&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span>
                <span class="k">else</span> <span class="n">right_data</span>
            <span class="p">)</span>

            <span class="c1"># Create a new step for the map operation</span>
            <span class="n">map_operation</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;synthesized_</span><span class="si">{</span><span class="n">output_key</span><span class="si">}</span><span class="s2">_extraction&quot;</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;map&quot;</span><span class="p">,</span>
                <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="n">map_prompt</span><span class="p">,</span>
                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_model&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">),</span>
                <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">output_key</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">}},</span>
                <span class="s2">&quot;optimize&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># Optimize the map operation</span>
            <span class="k">if</span> <span class="n">map_operation</span><span class="p">[</span><span class="s2">&quot;optimize&quot;</span><span class="p">]:</span>
                <span class="n">dataset_to_transform_sample</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
                    <span class="n">dataset_to_transform</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;map&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">optimized_map_operations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_map</span><span class="p">(</span>
                    <span class="n">map_operation</span><span class="p">,</span> <span class="n">dataset_to_transform_sample</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">optimized_map_operations</span> <span class="o">=</span> <span class="p">[</span><span class="n">map_operation</span><span class="p">]</span>

            <span class="n">new_step</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;synthesized_</span><span class="si">{</span><span class="n">output_key</span><span class="si">}</span><span class="s2">_extraction&quot;</span><span class="p">,</span>
                <span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="p">(</span>
                    <span class="n">left_name</span>
                    <span class="k">if</span> <span class="n">agent_results</span><span class="p">[</span><span class="s2">&quot;dataset_to_transform&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span>
                    <span class="k">else</span> <span class="n">right_name</span>
                <span class="p">),</span>
                <span class="s2">&quot;operations&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">mo</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">mo</span> <span class="ow">in</span> <span class="n">optimized_map_operations</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">agent_results</span><span class="p">[</span><span class="s2">&quot;dataset_to_transform&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span><span class="p">:</span>
                <span class="n">new_left_name</span> <span class="o">=</span> <span class="n">new_step</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_right_name</span> <span class="o">=</span> <span class="n">new_step</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">optimized_map_op</span> <span class="ow">in</span> <span class="n">optimized_map_operations</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">optimized_map_op</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_step</span><span class="p">)</span>

            <span class="c1"># Now run the optimized map operation on the entire dataset_to_transform</span>
            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">optimized_map_operations</span><span class="p">:</span>
                <span class="n">dataset_to_transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_operation</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">dataset_to_transform</span><span class="p">)</span>

            <span class="c1"># Update the appropriate dataset for the next iteration</span>
            <span class="k">if</span> <span class="n">agent_results</span><span class="p">[</span><span class="s2">&quot;dataset_to_transform&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;left&quot;</span><span class="p">:</span>
                <span class="n">left_data</span> <span class="o">=</span> <span class="n">dataset_to_transform</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">right_data</span> <span class="o">=</span> <span class="n">dataset_to_transform</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Optimizing equijoin operation with </span><span class="si">{</span><span class="n">output_key</span><span class="si">}</span><span class="s2"> extraction&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Pop off &quot;left&quot; and &quot;right&quot; from the op_config</span>
        <span class="n">op_config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
        <span class="n">op_config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">[</span><span class="n">op_config</span><span class="p">],</span>
            <span class="p">{</span><span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="n">left_data</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="n">right_data</span><span class="p">},</span>
            <span class="n">new_left_name</span><span class="p">,</span>
            <span class="n">new_right_name</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_optimize_map</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">op_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">is_filter</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optimize a map operation.</span>

<span class="sd">        This method creates a MapOptimizer instance and uses it to optimize the map operation.</span>

<span class="sd">        Args:</span>
<span class="sd">            op_config (Dict[str, Any]): The configuration of the map operation.</span>
<span class="sd">            input_data (List[Dict[str, Any]]): The input data for the map operation.</span>
<span class="sd">            is_filter (bool, optional): If True, the operation is a filter operation. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Dict[str, Any]]: The optimized operation configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">map_optimizer</span> <span class="o">=</span> <span class="n">MapOptimizer</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_operation</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">is_filter</span><span class="o">=</span><span class="n">is_filter</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">optimized_ops</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">map_optimizer</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">op_config</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operations_cost</span> <span class="o">+=</span> <span class="n">cost</span>
        <span class="k">return</span> <span class="n">optimized_ops</span>

    <span class="k">def</span> <span class="nf">_optimize_resolve</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">op_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">input_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optimize a resolve operation.</span>

<span class="sd">        This method creates a JoinOptimizer instance and uses it to optimize the resolve operation.</span>
<span class="sd">        It updates the operation cost and runs the optimized operation.</span>

<span class="sd">        Args:</span>
<span class="sd">            op_config (Dict[str, Any]): The configuration of the resolve operation.</span>
<span class="sd">            input_data (List[Dict[str, Any]]): The input data for the resolve operation.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Dict[str, Any]]: The optimized operation configuration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">optimized_config</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">JoinOptimizer</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="n">op_config</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
            <span class="n">target_recall</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resolve&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_recall&quot;</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">optimize_resolve</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">optimized_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;empty&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="c1"># Remove this operation from the pipeline and just return input data</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="n">input_data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">operations_cost</span> <span class="o">+=</span> <span class="n">cost</span>

        <span class="c1"># Update the operation config with the optimized values</span>
        <span class="n">op_config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">optimized_config</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">op_config</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_run_operation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">op_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">input_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">return_instance</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">is_build</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">BaseOperation</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a single operation based on its configuration.</span>

<span class="sd">        This method creates an instance of the appropriate operation class and executes it.</span>
<span class="sd">        It also updates the total operation cost.</span>

<span class="sd">        Args:</span>
<span class="sd">            op_config (Dict[str, Any]): The configuration of the operation to run.</span>
<span class="sd">            input_data (List[Dict[str, Any]]): The input data for the operation.</span>
<span class="sd">            return_instance (bool, optional): If True, return the operation instance along with the output data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[List[Dict[str, Any]], Tuple[List[Dict[str, Any]], BaseOperation]]:</span>
<span class="sd">            If return_instance is False, returns the output data.</span>
<span class="sd">            If return_instance is True, returns a tuple of the output data and the operation instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">operation_class</span> <span class="o">=</span> <span class="n">get_operation</span><span class="p">(</span><span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">])</span>

        <span class="n">oc_kwargs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;runner&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">op_config</span><span class="p">,</span>
            <span class="s2">&quot;default_model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;default_model&quot;</span><span class="p">],</span>
            <span class="s2">&quot;max_threads&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
            <span class="s2">&quot;console&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">operation_instance</span> <span class="o">=</span> <span class="n">operation_class</span><span class="p">(</span><span class="o">**</span><span class="n">oc_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;equijoin&quot;</span><span class="p">:</span>
            <span class="n">left_data</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span>
            <span class="n">right_data</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span>
            <span class="n">output_data</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">operation_instance</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">left_data</span><span class="p">,</span> <span class="n">right_data</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;filter&quot;</span><span class="p">:</span>
            <span class="n">output_data</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">operation_instance</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">is_build</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_data</span><span class="p">,</span> <span class="n">cost</span> <span class="o">=</span> <span class="n">operation_instance</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operations_cost</span> <span class="o">+=</span> <span class="n">cost</span>
        <span class="k">if</span> <span class="n">return_instance</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output_data</span><span class="p">,</span> <span class="n">operation_instance</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output_data</span>

    <span class="c1"># Recursively resolve all anchors and aliases</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">resolve_anchors</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursively resolve all anchors and aliases in a nested data structure.</span>

<span class="sd">        This static method traverses through dictionaries and lists, resolving any YAML anchors and aliases.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: The data structure to resolve. Can be a dictionary, list, or any other type.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The resolved data structure with all anchors and aliases replaced by their actual values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">Optimizer</span><span class="o">.</span><span class="n">resolve_anchors</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">Optimizer</span><span class="o">.</span><span class="n">resolve_anchors</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">clean_optimized_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove _intermediates from each operation in the optimized config</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create a copy of the optimized config to modify</span>
        <span class="n">config_to_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">resolved_config</span> <span class="o">=</span> <span class="n">Optimizer</span><span class="o">.</span><span class="n">resolve_anchors</span><span class="p">(</span><span class="n">config_to_save</span><span class="p">)</span>

        <span class="c1"># Remove _intermediates from each operation in resolved_config</span>
        <span class="k">if</span> <span class="s2">&quot;operations&quot;</span> <span class="ow">in</span> <span class="n">resolved_config</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">op_config</span> <span class="ow">in</span> <span class="n">resolved_config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s2">&quot;_intermediates&quot;</span> <span class="ow">in</span> <span class="n">op_config</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;_intermediates&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">resolved_config</span>

    <span class="k">def</span> <span class="nf">save_optimized_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the optimized configuration to a YAML file.</span>

<span class="sd">        This method creates a copy of the optimized configuration, resolves all anchors and aliases,</span>
<span class="sd">        and saves it to a new YAML file. The new file name is based on the original file name with &#39;_opt&#39; appended.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resolved_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_optimized_config</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimized_config_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="n">resolved_config</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[green italic]💾 Optimized config saved to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">optimized_config_path</span><span class="si">}</span><span class="s2">[/green italic]&quot;</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="docetl.Optimizer.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">yaml_file_suffix</span><span class="p">,</span> <span class="n">max_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s1">&#39;gpt-4o&#39;</span><span class="p">,</span> <span class="n">resume</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the Optimizer class.</p>
<p>This method sets up the optimizer with the given configuration file and parameters.
It loads the configuration, initializes the console for output, sets up the LLM client,
and prepares various attributes for optimization.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>yaml_file</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the YAML configuration file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>max_threads</code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[int]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of threads to use for parallel processing.
If None, it will be set to (number of CPUs * 4).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>model</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the language model to use. Defaults to "gpt-4o".</p>
              </div>
            </td>
            <td>
                  <code>&#39;gpt-4o&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>resume</code></td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to resume optimization from a previous run. Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>timeout</code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Timeout in seconds for operations. Defaults to 60.</p>
              </div>
            </td>
            <td>
                  <code>60</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="docetl.Optimizer.__init__.yaml_file_path">yaml_file_path</span></code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Stores the path to the YAML file.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.Optimizer.__init__.config">config</span></code></td>
            <td>
                  <code><span title="typing.Dict">Dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Stores the loaded configuration from the YAML file.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.Optimizer.__init__.console">console</span></code></td>
            <td>
                  <code><span title="rich.console.Console">Console</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Rich console for formatted output.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.Optimizer.__init__.optimized_config">optimized_config</span></code></td>
            <td>
                  <code><span title="typing.Dict">Dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A copy of the original config to be optimized.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.Optimizer.__init__.llm_client">llm_client</span></code></td>
            <td>
                  <code><span title="docetl.optimizers.utils.LLMClient">LLMClient</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Client for interacting with the language model.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.Optimizer.__init__.max_threads">max_threads</span></code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of threads for parallel processing.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.Optimizer.__init__.operations_cost">operations_cost</span></code></td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tracks the total cost of operations.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.Optimizer.__init__.timeout">timeout</span></code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Timeout for operations in seconds.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.Optimizer.__init__.selectivities">selectivities</span></code></td>
            <td>
                  <code><span title="collections.defaultdict">defaultdict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Stores selectivity information for operations.
Selectivity is the ratio of output size to input size for an operation.
It's used to estimate how much data will flow through the pipeline after
each operation, which helps in optimizing subsequent operations and
determining appropriate sample sizes. For example, a selectivity of 0.5
means an operation halves the size of its input data.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="docetl.Optimizer.__init__.datasets">datasets</span></code></td>
            <td>
                  <code><span title="typing.Dict">Dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Stores loaded datasets.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>The method also calls print_optimizer_config() to display the initial configuration.</p>

            <details class="quote">
              <summary>Source code in <code>docetl/builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">base_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">yaml_file_suffix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">max_threads</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span>
    <span class="n">resume</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize the Optimizer class.</span>

<span class="sd">    This method sets up the optimizer with the given configuration file and parameters.</span>
<span class="sd">    It loads the configuration, initializes the console for output, sets up the LLM client,</span>
<span class="sd">    and prepares various attributes for optimization.</span>

<span class="sd">    Args:</span>
<span class="sd">        yaml_file (str): Path to the YAML configuration file.</span>
<span class="sd">        max_threads (Optional[int]): Maximum number of threads to use for parallel processing.</span>
<span class="sd">            If None, it will be set to (number of CPUs * 4).</span>
<span class="sd">        model (str): The name of the language model to use. Defaults to &quot;gpt-4o&quot;.</span>
<span class="sd">        resume (bool): Whether to resume optimization from a previous run. Defaults to False.</span>
<span class="sd">        timeout (int): Timeout in seconds for operations. Defaults to 60.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        yaml_file_path (str): Stores the path to the YAML file.</span>
<span class="sd">        config (Dict): Stores the loaded configuration from the YAML file.</span>
<span class="sd">        console (Console): Rich console for formatted output.</span>
<span class="sd">        optimized_config (Dict): A copy of the original config to be optimized.</span>
<span class="sd">        llm_client (LLMClient): Client for interacting with the language model.</span>
<span class="sd">        max_threads (int): Maximum number of threads for parallel processing.</span>
<span class="sd">        operations_cost (float): Tracks the total cost of operations.</span>
<span class="sd">        timeout (int): Timeout for operations in seconds.</span>
<span class="sd">        selectivities (defaultdict): Stores selectivity information for operations.</span>
<span class="sd">            Selectivity is the ratio of output size to input size for an operation.</span>
<span class="sd">            It&#39;s used to estimate how much data will flow through the pipeline after</span>
<span class="sd">            each operation, which helps in optimizing subsequent operations and</span>
<span class="sd">            determining appropriate sample sizes. For example, a selectivity of 0.5</span>
<span class="sd">            means an operation halves the size of its input data.</span>
<span class="sd">        datasets (Dict): Stores loaded datasets.</span>

<span class="sd">    The method also calls print_optimizer_config() to display the initial configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ConfigWrapper</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">max_threads</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span> <span class="o">=</span> <span class="n">LLMClient</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">operations_cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">selectivities</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">samples_taken</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">resume</span>

    <span class="c1"># create parsing tool map</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">parsing_tool_map</span> <span class="o">=</span> <span class="n">create_parsing_tool_map</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parsing_tools&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">home_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)</span>
    <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;.docetl/cache/</span><span class="si">{</span><span class="n">yaml_file_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="n">DatasetOnDisk</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">optimized_ops_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cache_dir</span><span class="si">}</span><span class="s2">/optimized_ops&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_opt.yaml&quot;</span>

    <span class="c1"># Update sample size map</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sample_size_map</span> <span class="o">=</span> <span class="n">SAMPLE_SIZE_MAP</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sample_sizes&quot;</span><span class="p">,</span> <span class="p">{}):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_size_map</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">][</span><span class="s2">&quot;sample_sizes&quot;</span><span class="p">])</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">step_op_to_optimized_ops</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">print_optimizer_config</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.Optimizer.clean_optimized_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clean_optimized_config</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Remove _intermediates from each operation in the optimized config</p>

            <details class="quote">
              <summary>Source code in <code>docetl/builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">clean_optimized_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove _intermediates from each operation in the optimized config</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create a copy of the optimized config to modify</span>
    <span class="n">config_to_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">resolved_config</span> <span class="o">=</span> <span class="n">Optimizer</span><span class="o">.</span><span class="n">resolve_anchors</span><span class="p">(</span><span class="n">config_to_save</span><span class="p">)</span>

    <span class="c1"># Remove _intermediates from each operation in resolved_config</span>
    <span class="k">if</span> <span class="s2">&quot;operations&quot;</span> <span class="ow">in</span> <span class="n">resolved_config</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">op_config</span> <span class="ow">in</span> <span class="n">resolved_config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s2">&quot;_intermediates&quot;</span> <span class="ow">in</span> <span class="n">op_config</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;_intermediates&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">resolved_config</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.Optimizer.compute_sample_size" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_sample_size</span><span class="p">(</span><span class="n">step_name</span><span class="p">,</span> <span class="n">step_ops</span><span class="p">,</span> <span class="n">op_config</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Compute the sample size necessary for optimizing given operation based on upstream operations.</p>
<p>This method calculates an appropriate sample size for an operation, taking into
account the selectivities of upstream operations in the same step. It uses a
predefined sample size map (SAMPLE_SIZE_MAP) as a starting point.</p>
<p>For example, if we have a 'map' operation with a default sample size of 10,
and one upstream operation with a selectivity of 0.5, the computed sample size for the upstream operation would be:
10 / 0.5 = 20</p>
<p>This ensures that after applying the selectivity of the upstream operation,
we still have a representative sample size for the current operation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>step_name</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the current step in the pipeline.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>step_ops</code></td>
            <td>
                  <code><span title="typing.List">List</span>[str]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of all operations in the current step.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>op_config</code></td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[str, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The configuration dictionary for the current operation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>int</code></td>            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The computed sample size for the operation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>The method works as follows:
1. If there are no upstream operations, it returns the default sample size for the operation type.
2. Otherwise, it starts with the default sample size and adjusts it based on the selectivities
   of upstream operations.
3. It iterates through upstream operations in reverse order, dividing the sample size by
   each operation's selectivity.
4. The final result is rounded to the nearest integer.</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>ValueError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the selectivity for any upstream operation is not found.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <ul>
<li>The method assumes that selectivities for all upstream operations have been
  previously computed and stored in self.selectivities.</li>
<li>The sample size is always at least 1, even after all adjustments.</li>
</ul>
</details>
            <details class="quote">
              <summary>Source code in <code>docetl/builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">compute_sample_size</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">step_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">step_ops</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">op_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the sample size necessary for optimizing given operation based on upstream operations.</span>

<span class="sd">    This method calculates an appropriate sample size for an operation, taking into</span>
<span class="sd">    account the selectivities of upstream operations in the same step. It uses a</span>
<span class="sd">    predefined sample size map (SAMPLE_SIZE_MAP) as a starting point.</span>

<span class="sd">    For example, if we have a &#39;map&#39; operation with a default sample size of 10,</span>
<span class="sd">    and one upstream operation with a selectivity of 0.5, the computed sample size for the upstream operation would be:</span>
<span class="sd">    10 / 0.5 = 20</span>

<span class="sd">    This ensures that after applying the selectivity of the upstream operation,</span>
<span class="sd">    we still have a representative sample size for the current operation.</span>

<span class="sd">    Args:</span>
<span class="sd">        step_name (str): The name of the current step in the pipeline.</span>
<span class="sd">        step_ops (List[str]): A list of all operations in the current step.</span>
<span class="sd">        op_config (Dict[str, Any]): The configuration dictionary for the current operation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: The computed sample size for the operation.</span>

<span class="sd">    The method works as follows:</span>
<span class="sd">    1. If there are no upstream operations, it returns the default sample size for the operation type.</span>
<span class="sd">    2. Otherwise, it starts with the default sample size and adjusts it based on the selectivities</span>
<span class="sd">       of upstream operations.</span>
<span class="sd">    3. It iterates through upstream operations in reverse order, dividing the sample size by</span>
<span class="sd">       each operation&#39;s selectivity.</span>
<span class="sd">    4. The final result is rounded to the nearest integer.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the selectivity for any upstream operation is not found.</span>

<span class="sd">    Note:</span>
<span class="sd">        - The method assumes that selectivities for all upstream operations have been</span>
<span class="sd">          previously computed and stored in self.selectivities.</span>
<span class="sd">        - The sample size is always at least 1, even after all adjustments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If an equijoin, load the default. Equijoins are always first</span>
    <span class="k">if</span> <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;equijoin&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SAMPLE_SIZE_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">))</span>

    <span class="c1"># If there are no upstream operations, use the default sample_size</span>
    <span class="n">upstream_ops</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">step_op</span> <span class="ow">in</span> <span class="n">step_ops</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">step_op</span> <span class="o">!=</span> <span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">step_op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_op_to_optimized_ops</span><span class="p">:</span>
                <span class="n">upstream_ops</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_op_to_optimized_ops</span><span class="p">[</span><span class="n">step_op</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">upstream_ops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_op</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">upstream_ops</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">))</span>

    <span class="c1"># Otherwise, compute the sample size based on the upstream operations</span>
    <span class="n">sample_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_size_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">op_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">upstream_ops</span><span class="p">):</span>
        <span class="c1"># Use the selectivity of the upstream operation to compute the sample size</span>
        <span class="k">if</span> <span class="n">op</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectivities</span><span class="p">[</span><span class="n">step_name</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Selectivity for operation </span><span class="si">{</span><span class="n">op</span><span class="si">}</span><span class="s2"> not found in selectivities. Other ops are </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">selectivities</span><span class="p">[</span><span class="n">step_name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">sample_size</span> <span class="o">=</span> <span class="n">sample_size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectivities</span><span class="p">[</span><span class="n">step_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">sample_size</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.Optimizer.optimize" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">optimize</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Optimize the entire pipeline defined in the configuration.</p>
<p>This method is the main entry point for the optimization process. It iterates through
each step in the pipeline, optimizing from upstream to downstream, and constructs an
optimized version of the configuration.</p>
<p>The optimization process includes:
1. Iterating through each step in the pipeline, from upstream to downstream.
2. Optimizing each step using the _optimize_step method.
3. Updating the optimized configuration with the new operations and steps.
4. Saving the optimized configuration to a file.
5. Logging the total costs (agent cost, operations cost, and total cost).</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Side effects:
- Modifies self.optimized_config with the optimized pipeline and operations.
- Updates self.datasets with the results of each step.
- Calls _save_optimized_config to save the optimized configuration to a file.
- Logs cost information to the console.</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>ValueError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If a step in the pipeline does not have a name.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
        <p>Note:
- This method assumes that all necessary data and configurations are already
  loaded and initialized in the Optimizer instance.
- The optimization process is performed step by step, from upstream to downstream,
  with each step potentially depending on the results of previous steps.</p>

            <details class="quote">
              <summary>Source code in <code>docetl/builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimize the entire pipeline defined in the configuration.</span>

<span class="sd">    This method is the main entry point for the optimization process. It iterates through</span>
<span class="sd">    each step in the pipeline, optimizing from upstream to downstream, and constructs an</span>
<span class="sd">    optimized version of the configuration.</span>

<span class="sd">    The optimization process includes:</span>
<span class="sd">    1. Iterating through each step in the pipeline, from upstream to downstream.</span>
<span class="sd">    2. Optimizing each step using the _optimize_step method.</span>
<span class="sd">    3. Updating the optimized configuration with the new operations and steps.</span>
<span class="sd">    4. Saving the optimized configuration to a file.</span>
<span class="sd">    5. Logging the total costs (agent cost, operations cost, and total cost).</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>

<span class="sd">    Side effects:</span>
<span class="sd">    - Modifies self.optimized_config with the optimized pipeline and operations.</span>
<span class="sd">    - Updates self.datasets with the results of each step.</span>
<span class="sd">    - Calls _save_optimized_config to save the optimized configuration to a file.</span>
<span class="sd">    - Logs cost information to the console.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If a step in the pipeline does not have a name.</span>

<span class="sd">    Note:</span>
<span class="sd">    - This method assumes that all necessary data and configurations are already</span>
<span class="sd">      loaded and initialized in the Optimizer instance.</span>
<span class="sd">    - The optimization process is performed step by step, from upstream to downstream,</span>
<span class="sd">      with each step potentially depending on the results of previous steps.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;[bold cyan]Beginning Pipeline Optimization[/bold cyan]&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">syntax_check</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_insert_empty_resolve_operations</span><span class="p">()</span>

    <span class="c1"># If resume is True, load the optimized operations from disk</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resume</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_optimized_ops</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]:</span>
        <span class="n">step_name</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">step_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Step does not have a name. Each step must have a unique name.&quot;</span>
            <span class="p">)</span>

        <span class="n">optimized_step</span><span class="p">,</span> <span class="n">step_operations</span><span class="p">,</span> <span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimize_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
        <span class="n">old_op_names</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">op</span>
            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">op</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">optimized_step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="c1"># Remove all old_op_names from self.optimized_config[&quot;operations&quot;]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">op</span>
            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">op</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">old_op_names</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">optimized_step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]:</span>
            <span class="n">changed_op</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">op_config</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">op_config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">op</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_operations</span><span class="p">[</span><span class="n">op</span><span class="p">]</span>
                    <span class="n">changed_op</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">changed_op</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">step_operations</span><span class="p">[</span><span class="n">op</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">step</span>
            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">step_name</span>
        <span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">optimized_step</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">step_op_to_optimized_ops</span><span class="p">[</span><span class="n">step_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimized_step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span>

        <span class="n">step_hash</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="n">s</span>
                            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span><span class="p">[</span><span class="s2">&quot;pipeline&quot;</span><span class="p">][</span><span class="s2">&quot;steps&quot;</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">step_name</span>
                        <span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s2">&quot;operations&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">find_operation</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimized_config</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">optimized_step</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]</span>
                        <span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
            <span class="o">+</span> <span class="s2">&quot;.json&quot;</span>
        <span class="p">)</span>
        <span class="c1"># If the dataset already exists, skip the step</span>
        <span class="k">if</span> <span class="n">step_hash</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">flush_cache</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">step_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_config&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;run_full_step&quot;</span><span class="p">,</span> <span class="p">[]</span>
        <span class="p">):</span>
            <span class="c1"># Run the entire step</span>
            <span class="n">input_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_partial_step</span><span class="p">(</span>
                <span class="n">step</span><span class="p">,</span>
                <span class="n">step_operations</span><span class="p">,</span>
                <span class="nb">float</span><span class="p">(</span><span class="s2">&quot;inf&quot;</span><span class="p">),</span>  <span class="c1"># TODO: FIX THIS</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">step_hash</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="n">step_hash</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[bold]Total agent cost: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">total_cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">[/bold]&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[bold]Total operations cost: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">operations_cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">[/bold]&quot;</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[bold]Total cost: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">total_cost</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">operations_cost</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">[/bold]&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.Optimizer.print_optimizer_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">print_optimizer_config</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Print the current configuration of the optimizer.</p>
<p>This method uses the Rich console to display a formatted output of the optimizer's
configuration. It includes details such as the YAML file path, sample sizes for
different operation types, maximum number of threads, the language model being used,
and the timeout setting.</p>
<p>The output is color-coded and formatted for easy readability, with a header and
separator lines to clearly delineate the configuration information.</p>

            <details class="quote">
              <summary>Source code in <code>docetl/builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">print_optimizer_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print the current configuration of the optimizer.</span>

<span class="sd">    This method uses the Rich console to display a formatted output of the optimizer&#39;s</span>
<span class="sd">    configuration. It includes details such as the YAML file path, sample sizes for</span>
<span class="sd">    different operation types, maximum number of threads, the language model being used,</span>
<span class="sd">    and the timeout setting.</span>

<span class="sd">    The output is color-coded and formatted for easy readability, with a header and</span>
<span class="sd">    separator lines to clearly delineate the configuration information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">rule</span><span class="p">(</span><span class="s2">&quot;[bold cyan]Optimizer Configuration[/bold cyan]&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow]Sample Size:[/yellow] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_size_map</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow]Max Threads:[/yellow] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow]Model:[/yellow] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_client</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[yellow]Timeout:[/yellow] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.Optimizer.resolve_anchors" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">resolve_anchors</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Recursively resolve all anchors and aliases in a nested data structure.</p>
<p>This static method traverses through dictionaries and lists, resolving any YAML anchors and aliases.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>data</code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The data structure to resolve. Can be a dictionary, list, or any other type.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The resolved data structure with all anchors and aliases replaced by their actual values.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>docetl/builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">resolve_anchors</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Recursively resolve all anchors and aliases in a nested data structure.</span>

<span class="sd">    This static method traverses through dictionaries and lists, resolving any YAML anchors and aliases.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: The data structure to resolve. Can be a dictionary, list, or any other type.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The resolved data structure with all anchors and aliases replaced by their actual values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">Optimizer</span><span class="o">.</span><span class="n">resolve_anchors</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">Optimizer</span><span class="o">.</span><span class="n">resolve_anchors</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.Optimizer.save_optimized_config" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save_optimized_config</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Save the optimized configuration to a YAML file.</p>
<p>This method creates a copy of the optimized configuration, resolves all anchors and aliases,
and saves it to a new YAML file. The new file name is based on the original file name with '_opt' appended.</p>

            <details class="quote">
              <summary>Source code in <code>docetl/builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">save_optimized_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save the optimized configuration to a YAML file.</span>

<span class="sd">    This method creates a copy of the optimized configuration, resolves all anchors and aliases,</span>
<span class="sd">    and saves it to a new YAML file. The new file name is based on the original file name with &#39;_opt&#39; appended.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resolved_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_optimized_config</span><span class="p">()</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimized_config_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="n">resolved_config</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[green italic]💾 Optimized config saved to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">optimized_config_path</span><span class="si">}</span><span class="s2">[/green italic]&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="docetl.Optimizer.syntax_check" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">syntax_check</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Perform a syntax check on all operations defined in the configuration.</p>
<p>This method validates each operation by attempting to instantiate it.
If any operation fails to instantiate, a ValueError is raised.</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>ValueError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If any operation fails the syntax check.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>docetl/builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">syntax_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform a syntax check on all operations defined in the configuration.</span>

<span class="sd">    This method validates each operation by attempting to instantiate it.</span>
<span class="sd">    If any operation fails to instantiate, a ValueError is raised.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If any operation fails the syntax check.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">operation_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;operations&quot;</span><span class="p">]:</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">operation_config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">operation_type</span> <span class="o">=</span> <span class="n">operation_config</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">operation_class</span> <span class="o">=</span> <span class="n">get_operation</span><span class="p">(</span><span class="n">operation_type</span><span class="p">)</span>
            <span class="n">operation_class</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">operation_config</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_model&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_threads</span><span class="p">,</span>
                <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Syntax check failed for operation &#39;</span><span class="si">{</span><span class="n">operation</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;[green]Syntax check passed for all operations.[/green]&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../../examples/rate-limiting/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Adding Rate Limiting">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Adding Rate Limiting
              </div>
            </div>
          </a>
        
        
          
          <a href="../cli/" class="md-footer__link md-footer__link--next" aria-label="Next: docetl.cli">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                docetl.cli
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.instant.prefetch", "navigation.tracking", "navigation.expand", "navigation.path", "navigation.prune", "navigation.indexes", "navigation.top", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "toc.follow", "navigation.footer", "content.code.copy", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.525ec568.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>